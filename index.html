<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Soundboard (PKCE + SDK)</title>
    
    <script src="http://googleusercontent.com/spotify.com/4"></script>

    <style>
        body { font-family: sans-serif; display: grid; place-items: center; min-height: 100vh; background: #f0f0f0; text-align: center; }
        #container { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        button { font-size: 1.2rem; padding: 10px 20px; cursor: pointer; background: #1DB954; color: white; border: none; border-radius: 50px; margin-top: 10px; }
        pre { background: #eee; padding: 10px; border-radius: 4px; word-wrap: break-word; text-align: left; }
    </style>
</head>
<body>

    <div id="container">
        <div id="login-section">
            <h1>Spotify Soundboard</h1>
            <p>Please log in to continue.</p>
            <button id="loginButton">Login with Spotify</button>
        </div>

        <div id="loading-section" style="display: none;">
            <p>Logging in, please wait...</p>
        </div>

        <div id="app-section" style="display: none;">
            <h2>Soundboard Ready!</h2>
            <p>Player Device ID:</p>
            <pre id="device-id-display">Waiting...</pre>
            
            <button id="playButton">Play Test Track</button>
            <p><small>(Note: You must be a Spotify Premium user)</small></p>
        </div>
    </div>

    <script>
        // --- 1. Configuration ---
        const clientId = 'bb82c1e306e44bc681b5fc345b2b493f';
        const redirectUri = 'https://valo-valox.github.io/spotify-soundboard/';
        
        // Add 'streaming' scope for the SDK
        const scope = 'streaming user-read-email user-read-private user-read-playback-state user-modify-playback-state';
        
        const tokenEndpoint = "https://accounts.spotify.com/authorize?";
        
        // This will hold our player instance
        let player = null;
        let deviceId = null;
        let accessToken = null; // Store token globally in the script

        // --- 2. Page Load Logic ---
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            
            // Check for token in localStorage first
            accessToken = localStorage.getItem('spotify_access_token');

            if (code) {
                // User has been redirected back from Spotify with a code
                showLoading();
                handleRedirect(code);
            } else if (accessToken) {
                // User is already logged in
                console.log("Found existing token in localStorage.");
                showApp(accessToken);
            } else {
                // User needs to log in
                showLogin();
            }

            // Bind the login button
            document.getElementById('loginButton').addEventListener('click', redirectToSpotifyLogin);
            // Bind the new play button
            document.getElementById('playButton').addEventListener('click', playTestTrack);
        });
        
        async function redirectToSpotifyLogin() {
            const codeVerifier = generateRandomString(64);
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            sessionStorage.setItem('spotify_code_verifier', codeVerifier);

            const params = new URLSearchParams();
            params.append('client_id', clientId);
            params.append('response_type', 'code');
            params.append('redirect_uri', redirectUri);
            params.append('scope', scope);
            params.append('code_challenge_method', 'S256');
            params.append('code_challenge', codeChallenge);

            document.location = `https://accounts.spotify.com/authorize?${params.toString()}`;
        }

        async function handleRedirect(code) {
            const codeVerifier = sessionStorage.getItem('spotify_code_verifier');
            if (!codeVerifier) {
                console.error("Error: No code verifier.");
                showLogin();
                return;
            }

            try {
                const tokenData = await getAccessToken(code, codeVerifier);
                
                accessToken = tokenData.access_token;
                localStorage.setItem('spotify_access_token', accessToken);
                localStorage.setItem('spotify_refresh_token', tokenData.refresh_token);
                
                window.history.pushState({}, null, '/'); // Clean up URL
                sessionStorage.removeItem('spotify_code_verifier');
                
                showApp(accessToken);
            } catch (error) {
                console.error("Error exchanging code for token:", error);
                showLogin();
            }
        }
        
        async function getAccessToken(code, codeVerifier) {
            const body = new URLSearchParams();
            body.append('grant_type', 'authorization_code');
            body.append('code', code);
            body.append('redirect_uri', redirectUri);
            body.append('client_id', clientId);
            body.append('code_verifier', codeVerifier);

            const response = await fetch(tokenEndpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: body.toString(),
            });

            if (!response.ok) throw new Error('HTTP status ' + response.status);
            return await response.json();
        }

        // --- 3. PKCE Helper Functions ---
        function generateRandomString(length) {
            let text = '';
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        async function generateCodeChallenge(codeVerifier) {
            const data = new TextEncoder().encode(codeVerifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
                .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        // --- 4. NEW: Spotify Player SDK Functions ---

        function initializeSpotifyPlayer(token) {
            // This function is called by the SDK script tag when it's ready
            window.onSpotifyWebPlaybackSDKReady = () => {
                console.log("Spotify Web Playback SDK is ready.");
                
                player = new Spotify.Player({
                    name: 'Valo-Valox Soundboard',
                    getOAuthToken: cb => { 
                        // This function provides the token to the SDK
                        // In a real app, you'd check for expiry and refresh
                        cb(token); 
                    },
                    volume: 0.5
                });

                // --- Player Event Listeners ---
                
                // Ready
                player.addListener('ready', ({ device_id }) => {
                    console.log('Ready with Device ID', device_id);
                    deviceId = device_id;
                    document.getElementById('device-id-display').textContent = device_id;
                });

                // Not Ready
                player.addListener('not_ready', ({ device_id }) => {
                    console.log('Device ID has gone offline', device_id);
                    deviceId = null;
                });

                // Player state changed
                player.addListener('player_state_changed', (state) => {
                    if (!state) {
                        return;
                    }
                    console.log("Player state changed:", state);
                    // You can update your UI here
                    // e.g., show current track, pause/play state
                });
                
                // Error handling
                player.addListener('initialization_error', ({ message }) => { console.error(message); });
                player.addListener('authentication_error', ({ message }) => { console.error(message); });
                player.addListener('account_error', ({ message }) => { console.error(message); });

                // Connect the player!
                player.connect().then(success => {
                    if (success) {
                        console.log('The Web Playback SDK successfully connected to Spotify!');
                    }
                });
            };
        }

        function playTestTrack() {
            if (!deviceId) {
                alert("Player is not ready yet. Please wait a moment.");
                return;
            }
            
            // This uses the Spotify Web API (not the player SDK) to start playback
            // A "test track" (e.g., Rick Astley)
            const trackUri = 'spotify:track:4cOdK2wGLETKBW3PvgPWqT'; 

            fetch(`http://googleusercontent.com/spotify.com/5{deviceId}`, {
                method: 'PUT',
                body: JSON.stringify({ uris: [trackUri] }),
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}` // Use the global token
                },
            });
        }

        // --- 5. UI Functions ---
        function showLogin() {
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('loading-section').style.display = 'none';
            document.getElementById('app-section').style.display = 'none';
        }
        
        function showLoading() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('loading-section').style.display = 'block';
            document.getElementById('app-section').style.display = 'none';
        }

        function showApp(token) {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('loading-section').style.display = 'none';
            document.getElementById('app-section').style.display = 'block';
            
            // ** Initialize the player here **
            initializeSpotifyPlayer(token);
        }
    </script>
</body>
</html>
