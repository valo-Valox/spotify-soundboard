<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Spotify Soundboard</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;display:flex;flex-direction:column;align-items:center;gap:12px;padding:24px;background:#0e1114;color:#e6eef3}
    .board{display:grid;grid-template-columns:repeat(3,120px);gap:12px}
    button{padding:12px;border-radius:10px;border:0;background:#1db954;color:#052012;font-weight:600;cursor:pointer}
    .muted{background:#2c2f33}
    .row{display:flex;gap:8px}
    input{padding:8px;border-radius:8px;border:1px solid #222;background:#fff;color:#000}
    .info{font-size:13px;color:#9fb1a0}
  </style>
</head>
<body>
  <h1>Spotify Soundboard</h1>
  <div class="info" id="status">Not signed in</div>
  <div class="row">
    <input id="clientId" placeholder="Paste your Spotify Client ID" style="width:360px" />
    <input id="redirectUri" placeholder="Redirect URI, e.g. https://your-username.github.io/spotify-soundboard/" style="width:360px" />
  </div>
  <div class="row">
    <button id="btnAuth">Sign in with Spotify</button>
    <button id="btnSignOut" class="muted">Sign out</button>
  </div>
  <div class="board">
    <button id="prev">Previous</button>
    <button id="play">Play</button>
    <button id="pause">Pause</button>
    <button id="next">Next</button>
    <button id="volDown">Vol -</button>
    <button id="volUp">Vol +</button>
    <button id="seekBack">Seek -10s</button>
    <button id="seekForward">Seek +10s</button>
    <button id="toggleShuffle">Shuffle</button>
  </div>
  <div class="row">
    <button id="currentTrack" class="muted">Get Track</button>
    <div id="trackInfo" class="info">No track info</div>
  </div>
  <script>
    // Full PKCE + Spotify Web API logic
    const AUTHORIZE_URL = 'https://accounts.spotify.com/authorize';
    const TOKEN_URL = 'https://accounts.spotify.com/api/token';
    const SCOPES = [
      'user-modify-playback-state',
      'user-read-playback-state',
      'user-read-currently-playing'
    ].join(' ');

    const $status = document.getElementById('status');
    const $clientId = document.getElementById('clientId');
    const $redirectUri = document.getElementById('redirectUri');

    function setStatus(s){ $status.textContent = s; }

    function randomString(length){
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
      let r = '';
      for(let i=0;i<length;i++) r += chars.charAt(Math.floor(Math.random()*chars.length));
      return r;
    }

    async function sha256(plain){
      const encoder = new TextEncoder();
      const data = encoder.encode(plain);
      const digest = await crypto.subtle.digest('SHA-256', data);
      return new Uint8Array(digest);
    }

    function base64UrlEncode(bytes){
      let str = btoa(String.fromCharCode(...bytes));
      str = str.replace(/=+$/,'').replace(/\+/g,'-').replace(/\//g,'_');
      return str;
    }

    async function makeCodeChallenge(verifier){
      const hashed = await sha256(verifier);
      return base64UrlEncode(hashed);
    }

    function qs(obj){
      return Object.entries(obj).map(([k,v])=>encodeURIComponent(k)+'='+encodeURIComponent(v)).join('&');
    }

    async function startAuth(){
      const clientId = $clientId.value.trim();
      const redirectUri = $redirectUri.value.trim();
      if(!clientId || !redirectUri){ alert('Set Client ID and Redirect URI'); return; }
      const state = randomString(16);
      const codeVerifier = randomString(64);
      const codeChallenge = await makeCodeChallenge(codeVerifier);
      localStorage.setItem('pkce_code_verifier', codeVerifier);
      localStorage.setItem('pkce_state', state);
      localStorage.setItem('sp_client_id', clientId);
      localStorage.setItem('sp_redirect_uri', redirectUri);

      const params = {
        client_id: clientId,
        response_type: 'code',
        redirect_uri: redirectUri,
        code_challenge_method: 'S256',
        code_challenge: codeChallenge,
        state: state,
        scope: SCOPES
      };

      window.location = AUTHORIZE_URL + '?' + qs(params);
    }

    async function handleCallback(){
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const state = params.get('state');
      if(!code) return;
      const storedState = localStorage.getItem('pkce_state');
      if(state !== storedState){ setStatus('State mismatch'); return; }
      setStatus('Exchanging code for token');
      const codeVerifier = localStorage.getItem('pkce_code_verifier');
      const clientId = localStorage.getItem('sp_client_id');
      const redirectUri = localStorage.getItem('sp_redirect_uri');
      const body = qs({
        grant_type: 'authorization_code',
        code: code,
        redirect_uri: redirectUri,
        client_id: clientId,
        code_verifier: codeVerifier
      });

      const res = await fetch(TOKEN_URL,{
        method: 'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded'},
        body: body
      });

      if(!res.ok){ const txt = await res.text(); setStatus('Token exchange failed ' + res.status + ' ' + txt); return; }

      const data = await res.json();
      localStorage.setItem('sp_access_token', data.access_token);
      localStorage.setItem('sp_refresh_token', data.refresh_token || '');
      const expiresAt = Date.now() + (data.expires_in || 3600)*1000;
      localStorage.setItem('sp_expires_at', expiresAt);
      setStatus('Signed in, token stored');
      history.replaceState(null, '', '/');
    }

    async function refreshTokenIfNeeded(){
      const expiresAt = Number(localStorage.getItem('sp_expires_at') || 0);
      if(Date.now() < expiresAt - 60000) return;
      const refresh_token = localStorage.getItem('sp_refresh_token');
      const clientId = localStorage.getItem('sp_client_id');
      if(!refresh_token || !clientId) return;
      setStatus('Refreshing token');
      const body = qs({
        grant_type: 'refresh_token',
        refresh_token: refresh_token,
        client_id: clientId
      });
      const res = await fetch(TOKEN_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body});
      if(!res.ok){ setStatus('Refresh failed ' + res.status); return; }
      const data = await res.json();
      localStorage.setItem('sp_access_token', data.access_token);
      const expiresAtNew = Date.now() + (data.expires_in || 3600)*1000;
      localStorage.setItem('sp_expires_at', expiresAtNew);
      setStatus('Token refreshed');
    }

    function getAuthHeader(){ return 'Bearer ' + localStorage.getItem('sp_access_token'); }

    async function api(path, method='GET', body=null){
      await refreshTokenIfNeeded();
      const headers = {'Authorization':getAuthHeader()};
      if(body && !(body instanceof FormData)) headers['Content-Type'] = 'application/json';
      const res = await fetch('https://api.spotify.com/v1' + path,{method,headers,body: body && (typeof body === 'string' ? body : JSON.stringify(body))});
      if(res.status === 204) return null;
      if(!res.ok){ const t = await res.text(); throw new Error(res.status + ' ' + t); }
      return await res.json();
    }

    async function play(){ await api('/me/player/play','PUT'); }
    async function pause(){ await api('/me/player/pause','PUT'); }
    async function next(){ await api('/me/player/next','POST'); }
    async function previous(){ await api('/me/player/previous','POST'); }
    async function setVolume(v){ await api('/me/player/volume?volume_percent='+v,'PUT'); }
    async function seek(posMs){ await api('/me/player/seek?position_ms='+posMs,'PUT'); }
    async function toggleShuffle(){
      const st = await api('/me/player');
      const current = st && st.shuffle_state;
      await api('/me/player/shuffle?state='+(!current),'PUT');
    }

    async function getCurrent(){
      try{
        const cur = await api('/me/player/currently-playing');
        if(!cur || !cur.item){ document.getElementById('trackInfo').textContent = 'No track playing'; return; }
        const artists = cur.item.artists.map(a=>a.name).join(', ');
        document.getElementById('trackInfo').textContent = cur.item.name + ' â€” ' + artists;
      }catch(e){ document.getElementById('trackInfo').textContent = 'Error: ' + e.message; }
    }

    // UI wiring
    document.getElementById('btnAuth').addEventListener('click', ()=>startAuth());
    document.getElementById('btnSignOut').addEventListener('click', ()=>{
      localStorage.removeItem('sp_access_token');
      localStorage.removeItem('sp_refresh_token');
      localStorage.removeItem('sp_expires_at');
      localStorage.removeItem('pkce_code_verifier');
      localStorage.removeItem('pkce_state');
      setStatus('Signed out');
    });
    document.getElementById('play').addEventListener('click', ()=>play().then(()=>setStatus('Played')).catch(e=>setStatus(e.message)));
    document.getElementById('pause').addEventListener('click', ()=>pause().then(()=>setStatus('Paused')).catch(e=>setStatus(e.message)));
    document.getElementById('next').addEventListener('click', ()=>next().then(()=>setStatus('Next')).catch(e=>setStatus(e.message)));
    document.getElementById('prev').addEventListener('click', ()=>previous().then(()=>setStatus('Previous')).catch(e=>setStatus(e.message)));
    document.getElementById('volUp').addEventListener('click', async ()=>{
      try{
        const st = await api('/me/player');
        const v = Math.min(100, (st && st.device && st.device.volume_percent) || 50 + 10);
        await setVolume(v);
        setStatus('Volume ' + v);
      }catch(e){ setStatus(e.message); }
    });
    document.getElementById('volDown').addEventListener('click', async ()=>{
      try{
        const st = await api('/me/player');
        const v = Math.max(0, (st && st.device && st.device.volume_percent) || 50 - 10);
        await setVolume(v);
        setStatus('Volume ' + v);
      }catch(e){ setStatus(e.message); }
    });
    document.getElementById('seekForward').addEventListener('click', async ()=>{
      try{
        const st = await api('/me/player');
        const pos = (st && st.progress_ms) || 0;
        await seek(pos + 10000);
        setStatus('Seek +10s');
      }catch(e){ setStatus(e.message); }
    });
    document.getElementById('seekBack').addEventListener('click', async ()=>{
      try{
        const st = await api('/me/player');
        const pos = (st && st.progress_ms) || 0;
        await seek(Math.max(0, pos - 10000));
        setStatus('Seek -10s');
      }catch(e){ setStatus(e.message); }
    });
    document.getElementById('toggleShuffle').addEventListener('click', ()=>toggleShuffle().then(()=>setStatus('Toggled shuffle')).catch(e=>setStatus(e.message)));
    document.getElementById('currentTrack').addEventListener('click', ()=>getCurrent());

    window.addEventListener('load', async ()=>{
      const ci = localStorage.getItem('sp_client_id');
      const ru = localStorage.getItem('sp_redirect_uri');
      if(ci) $clientId.value = ci;
      if(ru) $redirectUri.value = ru;
      await handleCallback();
      if(localStorage.getItem('sp_access_token')) setStatus('Signed in');
    });
  </script>
</body>
</html>